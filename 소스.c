#include <stdio.h>
#include <string.h>
#include <stdlib.h>

int fIntro();
int fFrom();
int fTo(int from);
int fSchedule(int from, int to);
void fSeat(int from, int to, int num);
int fPersnal(int from, int to, int num, int seatA, int seatB);
int fChange();

char city[4][10] = { "일    본","호    주","캐 나 다","대한민국" };

int main()
{
	while (1)
	{
		int from;
		int to;
		int num;
		int ch = fIntro();
		if (ch == 1) {
			while (1) {
				from = fFrom();
				if (from != -1)
					break;
			}
			while (1) {
				to = fTo(from);
				if (to != -1)
					break;
			}
			while (1) {
				num = fSchedule(from, to);
				if (num != -1)
					break;
			}
			fSeat(from, to, num);
		}
		else if (ch == 2) {
			break;
		}
		else if (ch == 3) {
			fChange();
		}
	}

	return 0;
}

int fIntro() {
	int ch = 0;
	FILE * file = fopen("Person.txt", "r");
	printf("\n\n\t\t┌───────────────────────┐\t\t\n");
	printf("\t\t│         비행기표 예매 프로그램 입니다.       │\t\t\n");
	printf("\t\t│                                              │\t\t\n");
	printf("\t\t│                  1.예   매                   │\t\t\n");
	printf("\t\t│                  2.종   료                   │\t\t\n");
	if (file != NULL)
	{
		printf("\t\t│                  3.조회 및 수정              │\t\t\n");
	}
	printf("\t\t│                                              │\t\t\n");
	printf("\t\t└───────────────────────┘\t\t\n");
	printf("\n\t\t>>");
	scanf("%d", &ch);
	system("cls");

	return ch;
}

int fFrom() {
	printf("\n\n\t\t┌───────────────────────┐\t\t\n");
	printf("\t\t│             출발지를 선택해주세요            │\t\t\n");
	printf("\t\t│                                              │\n\n");
	for (int i = 0; i < 4; i++)
	{
		printf("\t\t│                   %s                   │\t\t\t\n", city[i]);
	}
	printf("\t\t└───────────────────────┘\t\t\n");
	printf("\n\t\t>>");
	char str[20];
	scanf("%s", &str);
	system("cls");
	if (!strcmp(str, "일본"))
	{
		return 0;
	}
	else if (!strcmp(str, "호주"))
	{
		return 1;
	}
	else if (!strcmp(str, "캐나다"))
	{
		return 2;
	}
	else if (!strcmp(str, "대한민국"))
	{
		return 3;
	}
	else
	{
		printf("알 수 없는 국가");
		return -1;
	}
}

int fTo(int from) {
	printf("\n\n\t\t┌───────────────────────┐\t\t\n");
	printf("\t\t│             도착지를 선택해주세요            │\t\t\n");
	printf("\t\t│                                              │\n\n");
	for (int i = 0; i < 4; i++)
	{
		if (i != from) {
			printf("\t\t│                   %s                   │\t\t\t\n", city[i]);
		}
	}
	printf("\t\t└───────────────────────┘\t\t\n");
	char str[20];
	printf("\n\t\t>>");
	scanf("%s", &str);
	system("cls");
	if (!strcmp(str, "일본") && from != 0)
	{
		return 0;
	}
	else if (!strcmp(str, "호주") && from != 1)
	{
		return 1;
	}
	else if (!strcmp(str, "캐나다") && from != 2)
	{
		return 2;
	}
	else if (!strcmp(str, "대한민국") && from != 3)
	{
		return 3;
	}
	else
	{
		return -1;
	}
}

int fSchedule(int from, int to)
{
	FILE * file = fopen("Schedule.txt", "r");
	int r_from;
	int r_to;
	char r_day[5];
	char r_time[6];
	char r_company[11];
	int num = 1;

	printf("\n\n\t\t┌───────────────────────┐\t\t\n");
	printf("\t\t│               시간을 선택해주세요            │\t\t\n");
	printf("\t\t│                                              │\n\n");
	while (!feof(file))
	{
		fscanf(file, "%d %d %s %s %s\n", &r_from, &r_to, &r_day, &r_time, &r_company);
		if (r_from == from && r_to == to)
		{
			printf("\t\t│    %2d      %5s일 %s %s          │\n\n", num, r_day, r_time, r_company);
			num++;
		}
	}
	printf("\t\t└───────────────────────┘\t\t\n");
	fclose(file);

	int ch;
	printf("\n\t\t>>");
	scanf("%d", &ch);

	system("cls");
	if (num < ch || ch < 1)
	{
		printf("올바르지 못한 시간대입니다.");
		return -1;
	}

	return ch;
}

void fSeat(int from, int to, int num)
{
	int seat[15][7] = { 0 }; //좌석
	char number[30];
	int seatA;
	int seatB;

	FILE * file = fopen("Person.txt", "r");
	if (file != NULL) {
		//fprintf(file, "%d %d %d %d %s %d %s %d %s\n", &from, &to, &num, &seatA, &seatB, &money, &name, &birth, &phone);
		while (!feof(file))
		{
			int r_from, r_to, r_num, r_seatA, r_seatB;
			//공백으로 분리된 파일 읽기
			fscanf(file, "%d %d %d %d %d %*d %*s %*d %*s\n", &r_from, &r_to, &r_num, &r_seatA, &r_seatB);

			if (from == r_from && to == r_to && num == r_num) {
				seat[r_seatA - 1][r_seatB - 1] = 1;
			}
		}
		fclose(file);
	}
	while (1) {
		printf("\n\n\t\t┌───────────────────────┐\t\t\n");
		printf("\t\t│ 좌석을 선택해주세요 (1~3행은 퍼스트석 입니다)│\t\t\n");
		printf("\t\t└───────────────────────┘\t\t\n");

		printf("\t\t\t\t    A B    C D E   F G\t\t\n");
		for (int i = 0; i < 15; i++) {
			printf("\t\t\t\t %2d ", i + 1);
			for (int j = 0; j < 7; j++) {
				if (seat[i][j] == 0)
				{
					printf("□");
				}
				else
				{
					printf("■");
				}
				if (j == 1 || j == 4)
					printf("  ");
			}
			printf("\n");
		}


		printf("\t\t\tex)1A\n\t\t\t\t>>");
		scanf("%3s", number);
		system("cls");
		if (strlen(number) == 2) {
			seatA = number[0] - 48;
			seatB = number[1] - 64;
		}
		else if (strlen(number) >= 3) {
			seatA = atoi(number);
			seatB = number[2] - 64;
		}
		if (seat[seatA - 1][seatB - 1] == 0)
		{
			break;
		}
		else
		{
			system("cls");
			printf("잘못된 좌석입니다.");
		}
	}
	fPersnal(from, to, num, seatA, seatB);
}

int fPersnal(int from, int to, int num, int seatA, int seatB)
{
	char name[20];
	int birth;
	char phone[15];
	printf("\t\t************개인정보 입력****************  \n");

	printf("\t\t이름:");
	scanf("%s", name);

	printf("\t\t생년월일 ex)19990101 :");
	scanf("%d", &birth);

	printf("\t\t전화번호 ex)000-1111-2222 :");
	scanf("%s", phone);



	system("cls");

	int money = 0; // 요금합계
	int y;
	int pay[4][4] = {
		{ 0, 500000, 352000, 531000 },//일본 -> 호주 캐나다 한국
		{ 535000, 0, 1080000, 535000 },//호주 -> 일본 캐나다 한국
		{ 406000, 782000, 0, 535000 },
		{ 305000, 478000, 470000, 0 } };
	money = money + pay[from][to];

	//나이요금계산
	if (birth <= 19990101)//성인요금
		money = money + 50000;
	else if (birth > 19981231) //청소년요금
		money = money + 30000;



	//좌석요금계산
	if (seatA <= 3) //퍼스트
		money = money + 100000;
	else //비즈니스
		money = money + 50000;


	printf("\n\n\t\t총 요금은 %d입니다.\n\n", money);
	printf("\t\t1. 결제하기   2.취소 \n");
	printf("\t\t>>");
	scanf("%d", &y);

	system("cls");
	if (y == 1)
	{
		FILE * file = fopen("Person.txt", "a");
		if (file == NULL)
		{
			//에러 처리
		}
		fprintf(file, "%d %d %d %d %d %d %s %d %s\n", from, to, num, seatA, seatB, money, name, birth, phone);
		fclose(file);
		return 0;
	}
	else
	{
		printf("결제 취소, 처음 화면으로 되돌아갑니다");
		return -1;
	}
}

int fChange() {
	int from;
	int to;
	int schd;
	while (1) {
		printf("\n\t\t┌───────────────────────┐\t\t\n");
		printf("\t\t│            수정할 곳을 선택합니다            │\t\t\n");
		printf("\t\t└───────────────────────┘\t\t\n");
		from = fFrom();
		if (from != -1)
			break;
	}
	while (1) {
		printf("\n\t\t┌───────────────────────┐\t\t\n");
		printf("\t\t│            수정할 곳을 선택합니다            │\t\t\n");
		printf("\t\t└───────────────────────┘\t\t\n");
		to = fTo(from);
		if (to != -1)
			break;
	}
	while (1) {
		printf("\n\n\t\t┌───────────────────────┐\t\t\n");
		printf("\t\t│            수정할 곳을 선택합니다            │\t\t\n");
		printf("\t\t└───────────────────────┘\t\t\n");	
		schd = fSchedule(from, to);
		if (schd != -1)
			break;
	}

	int seat[15][7] = { 0 }; //좌석
	char number[30];
	int seatA;
	int seatB;

	FILE * file = fopen("Person.txt", "r+");
	while (!feof(file))
	{
		int r_from, r_to, r_num, r_seatA, r_seatB;
		//공백으로 분리된 파일 읽기전용 변수 선언
		fscanf(file, "%d %d %d %d %d %*d %*s %*d %*s\n", &r_from, &r_to, &r_num, &r_seatA, &r_seatB);
		
		if (from == r_from && to == r_to && schd == r_num) {
			seat[r_seatA - 1][r_seatB - 1] = 1;
		}
	}
	while (1) {
		printf("\n\n\t\t┌───────────────────────┐\t\t\n");
		printf("\t\t│            수정할 곳을 선택합니다            │\t\t\n");
		printf("\t\t└───────────────────────┘\t\t\n");
		
		printf("\n\n\t\t┌───────────────────────┐\t\t\n");
		printf("\t\t│ 좌석을 선택해주세요 (1~3행은 퍼스트석 입니다)│\t\t\n");
		printf("\t\t└───────────────────────┘\t\t\n");

		printf("\t\t\t\t    A B    C D E   F G\t\t\n");
		for (int i = 0; i < 15; i++) {
			printf("\t\t\t\t %2d ", i + 1);
			for (int j = 0; j < 7; j++) {
				if (seat[i][j] == 0)
				{
					printf("□");
				}
				else
				{
					printf("■");
				}
				if (j == 1 || j == 4)
					printf("  ");
			}
			printf("\n");
		}


		printf("\t\t\tex)1A\n\t\t\t\t>>");
		scanf("%3s", number);
		system("cls");
		if (strlen(number) == 2) {
			seatA = number[0] - 48;
			seatB = number[1] - 64;
		}
		else if (strlen(number) >= 3) {
			seatA = atoi(number); //문자 빼고 정수만을 잡아오는 함수
			seatB = number[2] - 64;
		}
		if (seat[seatA - 1][seatB - 1] == 1)
		{
			break;
		}
		else
		{
			system("cls");
			printf("잘못된 좌석입니다.");
		}
	}
	rewind(file);
	int r_from, r_to, r_num, r_seatA, r_seatB, r_money, r_birth; //읽기 전용 변수
	char r_name[20], r_phone[15];
	int count = 0;
	while (!feof(file))
	{
		//공백으로 분리된 파일 읽기
		fscanf(file, "%d %d %d %d %d %d %s %d %s\n", &r_from, &r_to, &r_num, &r_seatA, &r_seatB, &r_money, r_name, &r_birth, r_phone);
		printf("해당 좌석 찾는중");
		if (from == r_from && to == r_to && schd == r_num && seatA == r_seatA && seatB == r_seatB) {
			rewind(file);
			break;
		}
		count++;;
	}
	fclose(file); // 조회
	while (1) {
		system("cls");
		int ch;
		char seatBB = (char)(r_seatB + 64); //조회한 내용이 같다면 저장되어있던 데이터를 호출
		printf("\t\t이름 : %s\n", r_name);
		printf("\t\t%s -> %s | 좌석 : %d%c\n", city[r_from], city[r_to], r_seatA, seatBB);
		printf("\t\t생년월일 : %d | 전화번호 : %s\n", r_birth, r_phone);
		printf("\t\t금액 : %d\n\n", r_money);
		int count = 0;
		printf("\n\n\t\t1. 삭제\n");
		printf("\t\t2. 취소\n"); //삭제 취소 결정
		printf("\n\t\t>>");
		scanf("%d", &ch);

		//삭제할 때
		if (ch == 1) {
			FILE * file = fopen("Person.txt", "rt");
			FILE * temp = fopen("Temp.txt", "w+"); //삭제할 파일을 Temp에 옮김
			while (!feof(file))//파일의 끝에 도달 할 때까지
			{
				fscanf(file, "%d %d %d %d %d %d %s %d %s\n", &r_from, &r_to, &r_num, &r_seatA, &r_seatB, &r_money, r_name, &r_birth, r_phone);
				if (from == r_from && to == r_to && schd == r_num && seatA == r_seatA && seatB == r_seatB) {
				}
				else {
					fprintf(temp, "%d %d %d %d %d %d %s %d %s\n", r_from, r_to, r_num, r_seatA, r_seatB, r_money, r_name, r_birth, r_phone);
					count++;
				}
			}
			fclose(temp);
			fclose(file); //파일 닫아주기

			temp = fopen("Temp.txt", "r+"); //r+는 읽기/쓰기 모드이다 이전 파일이 없으면 에러
			file = fopen("Person.txt", "w+"); //Person.txt w+ 연산자를 이용해서 파일 새로 생성
			int from = NULL, to, num, seatA, seatB, money, birth;
			char name[20], phone[15];
			while (!feof(temp)) {
				fscanf(temp, "%d %d %d %d %d %d %s %d %s\n", &from, &to, &num, &seatA, &seatB, &money, name, &birth, phone);
				if (count != 0) {
					fprintf(file, "%d %d %d %d %d %d %s %d %s\n", from, to, num, seatA, seatB, money, name, birth, phone);//지워줌
				}
			}
			fprintf(file, "\n");//한칸 뜀
			fclose(temp);
			fclose(file);
			break;
		}
		//삭제가 아니라면 그냥 빠져나간다
		else if (ch == 2) {
			break;
		}
	}

	return 0;
}
